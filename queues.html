<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Working with Queues
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Stuff" />
    <meta name="author" content="Isaac Abraham" />

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet" />

    <link type="text/css" rel="stylesheet" href="./content/style.css" />
    <link type="text/css" rel="stylesheet" href="deedle.css" />
    <script type="text/javascript" src="./content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <div class="container">
        <div class="masthead">
            <ul class="nav nav-pills pull-right">
                <li><a href="http://fsharp.org">fsharp.org</a></li>
                <li><a href="http://github.com/fsprojects/AzureStorageTypeProvider">github page</a></li>
            </ul>
            <h3 class="muted"><a href="./index.html">Azure Storage Type Provider</a></h3>
        </div>
        <hr />
        <div class="row">
            <div class="span9" id="main">
                
<h1><a name="Working-with-Queues" class="anchor" href="#Working-with-Queues">Working with Queues</a></h1>
<p>For more information on Queues in general, please see some of the many articles on
<a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.queue.aspx">MSDN</a> or the <a href="http://azure.microsoft.com/en-us/documentation/services/storage/">Azure</a> <a href="http://azure.microsoft.com/en-us/documentation/articles/storage-dotnet-how-to-use-queues/">documentation</a>. Some of the core features of the Queue provider are: -</p>
<h2><a name="Rapid-navigation" class="anchor" href="#Rapid-navigation">Rapid navigation</a></h2>
<p>You can easily move between queues and view key information on that queue. Simply dotting into
a queue will automatically request the latest details on the queue. This allows easy exploration
of your queue assets, directly from within the REPL.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">queue</span> <span class="o">=</span> <span class="i">Azure</span><span class="o">.</span><span class="i">Queues</span><span class="o">.</span><span class="i">``sample-queue``</span>
<span class="i">printfn</span> <span class="s">&quot;Queue &#39;%s&#39; has %d items on it.&quot;</span> <span class="i">queue</span><span class="o">.</span><span class="i">Name</span> (<span class="i">queue</span><span class="o">.</span><span class="i">GetCurrentLength</span>())
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>Queue 'sample-queue' has 0 items on it.</code></pre></td></tr></table>
<h2><a name="Processing-messages" class="anchor" href="#Processing-messages">Processing messages</a></h2>
<p>It is easy to push and pop messages onto / off a queue - simply call the Enqueue() and Dequeue()
methods on the appropriate queue. Enqueue will return an option message, in case there is nothing
on the queue. Once you have finished processing the message, simply call Delete().</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">async</span> {
    <span class="i">printfn</span> <span class="s">&quot;Queue length is %d.&quot;</span> (<span class="i">queue</span><span class="o">.</span><span class="i">GetCurrentLength</span>())

    <span class="c">// Put a message on the queue</span>
    <span class="i">printfn</span> <span class="s">&quot;Enqueuing a message!&quot;</span>
    <span class="k">do!</span> <span class="i">queue</span><span class="o">.</span><span class="i">Enqueue</span>(<span class="s">&quot;Hello from Azure Type Provider&quot;</span>)
    <span class="i">printfn</span> <span class="s">&quot;Queue length is %d.&quot;</span> (<span class="i">queue</span><span class="o">.</span><span class="i">GetCurrentLength</span>())

    <span class="c">// Get the message back off the queue</span>
    <span class="k">let</span> <span class="i">dequeuedMessage</span> <span class="o">=</span> (<span class="i">queue</span><span class="o">.</span><span class="i">Dequeue</span>() <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>)<span class="o">.</span><span class="i">Value</span> <span class="c">// don&#39;t try this at home :)</span>
    <span class="i">printfn</span> <span class="s">&quot;%A&quot;</span> <span class="i">dequeuedMessage</span>
    
    <span class="c">// Delete it off the queue to tell Azure we&#39;re done with it.</span>
    <span class="i">printfn</span> <span class="s">&quot;Deleting the message.&quot;</span>
    <span class="k">do!</span> <span class="i">queue</span><span class="o">.</span><span class="i">DeleteMessage</span> <span class="i">dequeuedMessage</span><span class="o">.</span><span class="i">Id</span>
    <span class="i">printfn</span> <span class="s">&quot;Queue length is %d.&quot;</span> (<span class="i">queue</span><span class="o">.</span><span class="i">GetCurrentLength</span>())
} <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>Queue length is 0.
Enqueuing a message!
Queue length is 1.
{Id =
  ProvidedMessageId
    (MessageId "c0dec0d8-c2dc-4cb1-8ea9-76c2814a050d",
     PopReceipt "sFs0Ccrr1AgBAAAA");
 DequeueCount = 1;
 InsertionTime = Some 25/08/2017 15:00:03 +00:00;
 ExpirationTime = Some 01/09/2017 15:00:03 +00:00;
 NextVisibleTime = Some 25/08/2017 15:00:33 +00:00;
 AsBytes = Value is not created.;
 AsString = Value is not created.;}
Deleting the message.
Queue length is 0.</code></pre></td></tr></table>
<h2><a name="Modifying-Queues" class="anchor" href="#Modifying-Queues">Modifying Queues</a></h2>
<p>You can easily modify the contents of an existing message and push it back onto the queue, or clear
the queue entirely. Note that the properties to access the payload (AsString and AsBytes) are lazily
evaluated and as such are exposed as Lazy<T>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">printMessage</span> <span class="i">msg</span> <span class="o">=</span>
    <span class="i">printfn</span> <span class="s">&quot;Message %A with body &#39;%s&#39; has been dequeued %d times.&quot;</span> <span class="i">msg</span><span class="o">.</span><span class="i">Id</span> <span class="i">msg</span><span class="o">.</span><span class="i">AsString</span><span class="o">.</span><span class="i">Value</span> <span class="i">msg</span><span class="o">.</span><span class="i">DequeueCount</span>

<span class="i">async</span> {
    <span class="i">printfn</span> <span class="s">&quot;Enqueuing a message!&quot;</span>
    <span class="k">do!</span> <span class="i">queue</span><span class="o">.</span><span class="i">Enqueue</span>(<span class="s">&quot;Hello from Azure Type Provider&quot;</span>)
    
    <span class="c">// Get the message, then put it back on the queue with a new payload immediately.</span>
    <span class="i">printfn</span> <span class="s">&quot;Dequeuing it.&quot;</span>
    <span class="k">let!</span> <span class="i">message</span> <span class="o">=</span> <span class="i">queue</span><span class="o">.</span><span class="i">Dequeue</span>()
    <span class="k">match</span> <span class="i">message</span> <span class="k">with</span>
    | <span class="i">Some</span> <span class="i">message</span> <span class="k">-&gt;</span>
        <span class="i">printMessage</span> <span class="i">message</span>
        <span class="i">printfn</span> <span class="s">&quot;Updating it and dequeuing it again.&quot;</span>
        <span class="k">do!</span> <span class="i">queue</span><span class="o">.</span><span class="i">UpdateMessage</span>(<span class="i">message</span><span class="o">.</span><span class="i">Id</span>, <span class="s">&quot;Goodbye from Azure Type Provider&quot;</span>)
        
        <span class="c">// Now dequeue the message again and interrogate it</span>
        <span class="k">let!</span> <span class="i">message</span> <span class="o">=</span> <span class="i">queue</span><span class="o">.</span><span class="i">Dequeue</span>()
        <span class="k">match</span> <span class="i">message</span> <span class="k">with</span>
        | <span class="i">Some</span> <span class="i">message</span> <span class="k">-&gt;</span>
            <span class="i">printMessage</span> <span class="i">message</span>
            <span class="k">do!</span> <span class="i">queue</span><span class="o">.</span><span class="i">DeleteMessage</span> <span class="i">message</span><span class="o">.</span><span class="i">Id</span>
        | <span class="i">None</span> <span class="k">-&gt;</span> ()
    | <span class="i">None</span> <span class="k">-&gt;</span> ()
} <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>Enqueuing a message!
Dequeuing it.
Message ProvidedMessageId
  (MessageId "644a094a-832c-4d6d-9934-42029eac0402",
   PopReceipt "EDhhCcrr1AgBAAAA") with body 'Hello from Azure Type Provider' has been dequeued 1 times.
Updating it and dequeuing it again.
Message ProvidedMessageId
  (MessageId "644a094a-832c-4d6d-9934-42029eac0402",
   PopReceipt "4GhvCcrr1AgCAAAA") with body 'Goodbye from Azure Type Provider' has been dequeued 2 times.</code></pre></td></tr></table>
<h2><a name="Shared-Access-Signature-generation" class="anchor" href="#Shared-Access-Signature-generation">Shared Access Signature generation</a></h2>
<p>The type provider exposes a simple method for generating time-dependant SAS codes for
queues. Omit permissions parameter to get full-access SAS token.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">duration</span> <span class="o">=</span> <span class="i">TimeSpan</span><span class="o">.</span><span class="i">FromMinutes</span> <span class="n">37.</span>
<span class="i">printfn</span> <span class="s">&quot;Current time: %O&quot;</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">UtcNow</span>
<span class="i">printfn</span> <span class="s">&quot;SAS expiry: %O&quot;</span> (<span class="i">DateTime</span><span class="o">.</span><span class="i">UtcNow</span><span class="o">.</span><span class="i">Add</span> <span class="i">duration</span>)
<span class="k">let</span> <span class="i">sasCode</span> <span class="o">=</span> <span class="i">queue</span><span class="o">.</span><span class="i">GenerateSharedAccessSignature</span>(<span class="i">duration</span>, <span class="i">permissions</span> <span class="o">=</span> (<span class="i">QueuePermission</span><span class="o">.</span><span class="i">Peek</span> <span class="o">|||</span> <span class="i">QueuePermission</span><span class="o">.</span><span class="i">Enqueue</span> <span class="o">|||</span> <span class="i">QueuePermission</span><span class="o">.</span><span class="i">DequeueAndDeleteMessageAndClear</span>)) 
<span class="i">printfn</span> <span class="s">&quot;SAS URI: %O&quot;</span> <span class="i">sasCode</span>
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>Current time: 25/08/2017 15:00:04
SAS expiry: 25/08/2017 15:37:04
SAS URI: ?sv=2015-12-11&amp;sig=MnX78bnW8U9zKuLCsV4H1s4QiBCsJxbrqVUz2zpbbeA%3D&amp;se=2017-08-25T15%3A37%3A04Z&amp;sp=rap</code></pre></td></tr></table>
<h2><a name="Peeking-the-queue" class="anchor" href="#Peeking-the-queue">Peeking the queue</a></h2>
<p>The Queue Provider allows you to preview messages on the queue directly in intellisense. Simply
dot into the "Peek" property on the queue, and the first 32 messages on the queue will appear.
Properties on them can be bound with their values.</p>


            </div>
            <div class="span3">
                <img src="./img/logo.png" alt="F# Project" style="width:150px;margin:10px" />
                <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
                    <li class="nav-header">Azure Storage Type Provider</li>
                    <li><a href="./index.html">Home page</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.nuget.org/packages/FSharp.Azure.StorageTypeProvider">Get Library via NuGet</a></li>
                    <li><a href="http://github.com/fsprojects/AzureStorageTypeProvider">Source Code on GitHub</a></li>
                    <li><a href="http://github.com/fsprojects/AzureStorageTypeProvider/blob/master/LICENSE.txt">License</a></li>
                    <li><a href="http://github.com/fsprojects/AzureStorageTypeProvider/blob/master/RELEASE_NOTES.md">Release Notes</a></li>

                    <li class="nav-header">Getting started</li>
                    <li><a href="./quickstart.html">Quick start</a></li>
                    <li><a href="./blobs.html">Using Azure Blobs</a></li>
                    <li><a href="./tables.html">Using Azure Tables</a></li>
                    <li><a href="./queues.html">Using Azure Storage Queues</a></li>

                    <li class="nav-header">Documentation</li>
                    <li><a href="./reference/index.html">API Reference</a></li>
                </ul>
            </div>
        </div>
    </div>
    <a href="http://github.com/fsprojects/AzureStorageTypeProvider"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" /></a>
</body>
</html>
